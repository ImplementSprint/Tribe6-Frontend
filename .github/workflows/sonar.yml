name: Universal CI (Jest & Vitest)

on:
  push:
    branches: [ "**" ]       # ðŸŸ¢ RUN ON ALL BRANCHES
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-and-scan:
    name: Test & SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for SonarCloud to detect new vs old code

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ----------------------------------------------------------------
      # ðŸ§ª UNIVERSAL TEST RUNNER (Jest & Vitest)
      # ----------------------------------------------------------------
      - name: Install & Run Tests
        run: |
          # Loop through all sub-projects (Backend, Web, Mobile)
          find . -name "package.json" -not -path "*/node_modules/*" | while read package_file; do
            dir=$(dirname "$package_file")
            echo "------------------------------------------------"
            echo "ðŸ“¦ Processing System: $dir"
            echo "------------------------------------------------"
            cd "$dir"

            # 1. Install Dependencies
            npm install

            # 2. Check which Test Runner is used (Jest or Vitest)
            if npm run | grep -q "test"; then
              echo "ðŸ§ª Detected test script. Running..."
              
              # Try running with coverage. 
              # This command works for both 'jest' and 'vitest run' 
              # IF the package.json script is set up correctly.
              npm test -- --coverage || echo "âš ï¸ Tests passed but coverage failed (or not configured). Continuing."
            else
              echo "âš ï¸ No 'test' script found in package.json. Skipping."
            fi
            
            cd - > /dev/null
          done

      # ----------------------------------------------------------------
      # ðŸ“¡ SONARCLOUD SCAN
      # ----------------------------------------------------------------
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
