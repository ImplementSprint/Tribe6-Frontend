name: CI (Jest + Vitest)

on:
  push:
    branches: [ "**" ]       # Runs on ALL branches
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-and-scan:
    name: Test & SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for SonarCloud

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ----------------------------------------------------------------
      # ðŸ§ª SMART TEST RUNNER
      # ----------------------------------------------------------------
      - name: Run Tests (Jest & Vitest)
        run: |
          # Loop through all folders containing package.json (excluding node_modules)
          find . -name "package.json" -not -path "*/node_modules/*" | while read package_file; do
            dir=$(dirname "$package_file")
            echo "------------------------------------------------"
            echo "ðŸ“¦ Found System: $dir"
            echo "------------------------------------------------"
            cd "$dir"

            # 1. Install Dependencies
            npm ci || npm install

            # 2. Check for Vitest (Frontend)
            if grep -q "vitest" package.json; then
                echo "âš¡ Detected VITEST (Frontend). Running..."
                npx vitest run --coverage --reporter=verbose
            
            # 3. Check for Jest (Backend/Mobile)
            elif grep -q "jest" package.json; then
                echo "ðŸƒ Detected JEST (Backend/Mobile). Running..."
                npx jest --coverage --ci --reporters=default
            
            else
                echo "âš ï¸ No test runner detected in package.json. Skipping."
            fi
            
            cd - > /dev/null
          done

      # ----------------------------------------------------------------
      # ðŸ“¡ SONARCLOUD SCAN
      # ----------------------------------------------------------------
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
