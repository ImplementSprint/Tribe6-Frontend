name: Mobile CI/CD Pipeline

on:
  push:
    branches: ["**"]
    paths:
      - 'SYSTEM_DIR/**'
      - '.github/workflows/mobile-ci-cd.yml'
      - '.github/workflows/governance-checks.yml'
  pull_request:
    paths: ['SYSTEM_DIR/**']

jobs:
  mobile-governance:
    name: Mobile - Governance Checks
    uses: ./.github/workflows/governance-checks.yml
    with:
      working-directory: 'SYSTEM_DIR'
      test-command: 'npx jest --coverage --ci --reporters=default'
      coverage-threshold: 80

  mobile-build-android:
    name: Mobile - Build Android
    needs: mobile-governance
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: ./SYSTEM_DIR } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm', cache-dependency-path: SYSTEM_DIR/package-lock.json }
      - uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '17' }
      - run: npm ci
      - run: |
          if [ -d "android" ]; then cd android && chmod +x gradlew && ./gradlew assembleRelease --no-daemon; fi
      - uses: actions/upload-artifact@v4
        with: { name: mobile-android-apk, path: SYSTEM_DIR/android/app/build/outputs/apk/release/*.apk }

  mobile-sonarcloud:
    name: Mobile - SonarCloud Quality Gate
    needs: mobile-governance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/download-artifact@v4
        with: { name: SYSTEM_DIR-coverage, path: SYSTEM_DIR/coverage }
      - uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: SYSTEM_DIR
          args: >
            -Dsonar.organization=implementsprint
            -Dsonar.projectKey=REPO_NAME_Mobile
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  mobile-deploy:
    name: Mobile - Deploy to Production
    needs: [mobile-build-android, mobile-sonarcloud]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production-mobile
    steps:
      - uses: actions/download-artifact@v4
        with: { name: mobile-android-apk, path: ./apk }
      - run: echo "ðŸš€ Deploying to Play Store..."
